---
- name: Render dockerfile from template
  template:
    src: "{{ docker_template_file }}"
    dest: "{{ docker_dockerfile_path }}/Dockerfile"
    mode: 0775
  when: docker_template_file is defined

- name: Create image from dockerfile
  shell: |
    docker build \
    --force-rm \
    --tag "build_{{ docker_image_name }}:{{ docker_image_tag }}" \
    "{{ docker_dockerfile_path }}"

- name: Run docker image for additional configuration
  command:
    argv:
      - docker
      - run
      - --name=build_tmp
      - --publish-all=true
      - --detach
      - "build_{{ docker_image_name }}:{{ docker_image_tag }}"
  register: build_image_id

- name: Get exposed port on localhost
  command:
    argv:
      - docker
      - port
      - --quiet
      - "{{ build_image_id.stdout }}"
      - 22
  register: build_image_ssh_port

- name: Add host to hosts list to process
  add_host:
    name: "127.0.0.1:{{ build_image_ssh_port.stdout }}"
    groups: just_created

- name: create a docker image from the container
  command:
    argv:
      - docker
      - commit
      - -c
      - EXPOSE 80
      - -c
      - CMD [\"nginx\", \"-g\", \"daemon off;\"]
      - build_tmp
      - "{{ docker_image_name }}:{{ docker_image_tag }}"
